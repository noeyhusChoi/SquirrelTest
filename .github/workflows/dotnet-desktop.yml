name: Squirrel Windows Package (.NET Framework 4.7.2)

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-package:
    runs-on: windows-latest

    steps:
      - name: 소스 체크아웃
        uses: actions/checkout@v4

      - name: NuGet.exe 다운로드
        run: |
          Invoke-WebRequest https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -OutFile nuget.exe

      - name: NuGet Restore
        run: nuget.exe restore SquirrelTest.sln

      - name: Release 빌드
        shell: cmd
        run: |
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe" SquirrelTest.sln /p:Configuration=Release

      - name: Squirrel.Windows 실행파일 다운로드
        run: |
          Invoke-WebRequest -Uri "https://github.com/Squirrel/Squirrel.Windows/releases/download/2.0.1/Squirrel.Windows.2.0.1.zip" -OutFile squirrel.windows.zip
          Expand-Archive squirrel.windows.zip -DestinationPath .\squirrel
        shell: pwsh

      - name: nuspec 파일 버전 치환
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          (Get-Content SquirrelTest.nuspec) -replace '\$version\$', $version | Set-Content SquirrelTest.generated.nuspec -Encoding UTF8

      - name: NuGet 패키지(nupkg) 생성
        run: |
          ./nuget.exe pack SquirrelTest.generated.nuspec

      - name: Squirrel 패키징 (Setup.exe, RELEASES 등 생성)
        run: |
          .\squirrel\Squirrel.exe --releasify SquirrelTest.*.nupkg

      - name: Release 업로드
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Setup.exe
            RELEASES
            SquirrelTest-*-full.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
